name: R-Release

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  build-r-source:
    runs-on: ubuntu-latest
    name: Build R Source Package (CRAN-ready)
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Copy LICENSE
        run: cp LICENSE package-r/LICENSE

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'
          
      - uses: r-lib/actions/setup-pandoc@v2

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::rcmdcheck, any::devtools, any::rextendr
          working-directory: package-r

      - name: Vendor Rust Dependencies
        run: |
          cd package-r/src/rust
          mkdir -p .cargo
          cargo vendor > .cargo/config.toml
          # Append config to use vendored sources
          # cargo vendor output is already in the correct format for config.toml 
          # but we need to ensure it replaces crates-io
          cat .cargo/config.toml

      - name: Build Source Package
        run: |
          R CMD build package-r
          
      - name: Check Package (as CRAN)
        run: |
          # Run check on the built tarball
          tarball=$(ls perpetual_*.tar.gz)
          echo "Checking $tarball"
          Rscript -e "rcmdcheck::rcmdcheck(path = '$tarball', args = c('--as-cran'), error_on = 'error')"
          
      - name: Upload Release Asset
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: perpetual_*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Artifact (for workflow dispatch/testing)
        uses: actions/upload-artifact@v4
        with:
          name: perpetual-cran-source
          path: perpetual_*.tar.gz
