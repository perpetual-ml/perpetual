name: Publish
on:
  release:
    types: [published]

jobs:
  prepare-resources:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          architecture: x64
      - name: Setup uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
      - name: Install dependencies for resource creation
        run: |
          uv pip install --system numpy pandas seaborn scikit-learn toml
          cp README.md package-python/README.md
          cp LICENSE package-python/LICENSE  
          cp LICENSE package-r/LICENSE
          mkdir -p resources
          cd package-python
          uv pip install --system -e .[dev]
          cd ..
      - name: Build test data (create resources)
        run: python scripts/make_resources.py
      - name: Upload Resources Artifact
        uses: actions/upload-artifact@v4
        with:
          name: perpetual-resources
          path: resources
          retention-days: 1

  windows-build:
    needs: prepare-resources
    strategy:
      matrix:
        pyversion: ["3.10", "3.11", "3.12", "3.13", "3.14"]
    runs-on: "windows-latest"
    steps:
      - uses: actions/checkout@v4
      - name: Download Resources Artifact
        uses: actions/download-artifact@v4
        with:
          name: perpetual-resources
          path: resources
      - name: Install latests stable Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.pyversion }}
          architecture: x64
      - name: Install deps
        run: pip install numpy pandas seaborn scikit-learn toml
      - run: |
          cp README.md package-python/README.md
          cp LICENSE package-python/LICENSE
          cp LICENSE package-r/LICENSE
      - name: Run PGO Optimization
        shell: bash
        run: |
          bash pgo_optimize.sh
          PGO_FILE=$(find target/pgo-profiles -name "*.profdata" | head -n 1)
          echo "PGO_PROFILE=$(pwd -W)/$PGO_FILE" >> $GITHUB_ENV
      - name: Build wheels with maturin
        uses: PyO3/maturin-action@v1
        with:
          target: x86_64
          command: build
          args: --release --strip --interpreter python --manifest-path package-python/Cargo.toml --out dist --sdist
        env:
          RUSTFLAGS: "-Cprofile-use=${{ env.PGO_PROFILE }}"
      - name: Save Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-windows-${{ matrix.pyversion }}
          path: dist

  macos-build:
    needs: prepare-resources
    strategy:
      matrix:
        pyversion: ["3.11", "3.12", "3.13", "3.14"]
        # macos-15-intel: Explicitly targeted as the Intel runner (Free).
        # macos-14: Explicitly targeted as the Apple Silicon runner (Free).
        os: [macos-15-intel, macos-14]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - name: Download Resources Artifact
        uses: actions/download-artifact@v4
        with:
          name: perpetual-resources
          path: resources
      - name: Install latest stable Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.pyversion }}
      - name: Install deps
        run: pip install numpy pandas seaborn scikit-learn toml
      - run: |
          cp README.md package-python/README.md
          cp LICENSE package-python/LICENSE
          cp LICENSE package-r/LICENSE
      - name: Run PGO Optimization
        shell: bash
        run: |
          bash pgo_optimize.sh
          PGO_FILE=$(find target/pgo-profiles -name "*.profdata" | head -n 1)
          echo "PGO_PROFILE=$PGO_FILE" >> $GITHUB_ENV
      - name: Build wheels with maturin
        uses: PyO3/maturin-action@v1
        with:
          command: build
          args: --release --strip --interpreter python --manifest-path package-python/Cargo.toml --out dist --sdist
        env:
          RUSTFLAGS: "-Cprofile-use=${{ env.PGO_PROFILE }}"
      - name: Save Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-${{ matrix.os }}-${{ matrix.pyversion }}
          path: dist

  linux-build:
    needs: prepare-resources
    runs-on: ubuntu-latest
    strategy:
      matrix:
        pyversion: ["3.10", "3.11", "3.12", "3.13", "3.14"]
    steps:
      - uses: actions/checkout@v4
      - name: Download Resources Artifact
        uses: actions/download-artifact@v4
        with:
          name: perpetual-resources
          path: resources
      - name: Install latests stable Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.pyversion }}
          architecture: x64
      - name: Install deps
        run: pip install numpy pandas seaborn scikit-learn toml
      - run: |
          cp README.md package-python/README.md
          cp LICENSE package-python/LICENSE
          cp LICENSE package-r/LICENSE
      - name: Run PGO Optimization
        shell: bash
        run: |
          bash pgo_optimize.sh
          PGO_FILE=$(find target/pgo-profiles -name "*.profdata" | head -n 1)
          cp "$PGO_FILE" "pgo_profile.profdata"
          echo "PGO_PROFILE=/io/pgo_profile.profdata" >> $GITHUB_ENV
      - name: Build wheels with maturin
        uses: PyO3/maturin-action@v1
        with:
          target: x86_64
          manylinux: auto
          command: build
          args: --release --strip --interpreter python${{ matrix.pyversion }} --manifest-path package-python/Cargo.toml --out dist --sdist
        env:
          RUSTFLAGS: "-Cprofile-use=${{ env.PGO_PROFILE }}"
      - name: Save Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-linux-${{ matrix.pyversion }}
          path: dist

  linux-arm-build:
    needs: prepare-resources
    runs-on: ubuntu-24.04-arm
    strategy:
      matrix:
        pyversion: ["3.10", "3.11", "3.12", "3.13", "3.14"]
    steps:
      - uses: actions/checkout@v4
      - name: Download Resources Artifact
        uses: actions/download-artifact@v4
        with:
          name: perpetual-resources
          path: resources
      - name: Install latests stable Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.pyversion }}
          architecture: arm64
      - name: Install deps
        run: pip install numpy pandas seaborn scikit-learn toml
      - run: |
          cp README.md package-python/README.md
          cp LICENSE package-python/LICENSE
          cp LICENSE package-r/LICENSE
      - name: Run PGO Optimization
        shell: bash
        run: |
          bash pgo_optimize.sh
          PGO_FILE=$(find target/pgo-profiles -name "*.profdata" | head -n 1)
          echo "PGO_PROFILE=$PWD/$PGO_FILE" >> $GITHUB_ENV
      - name: Build wheels with maturin
        uses: PyO3/maturin-action@v1
        with:
          manylinux: auto
          command: build
          args: --release --strip --interpreter python${{ matrix.pyversion }} --manifest-path package-python/Cargo.toml --out dist --sdist
        env:
          RUSTFLAGS: "-Cprofile-use=${{ env.PGO_PROFILE }}"
      - name: Save Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist-linux-arm-${{ matrix.pyversion }}
          path: dist

  cargo-publish:
    runs-on: ubuntu-latest
    needs: pypi-publish
    steps:
      - uses: actions/checkout@v4
      - name: Install latest stable Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          architecture: x64
      - name: Install deps
        run: pip install numpy pandas seaborn scikit-learn toml
      - run: |
          cp README.md package-python/README.md
          cp LICENSE package-python/LICENSE
          cp LICENSE package-r/LICENSE
      - name: Publish Crate
        run: cargo publish --token ${CRATES_TOKEN} --allow-dirty
        env:
          CRATES_TOKEN: ${{ secrets.CRATES_TOKEN }}

  pypi-publish:
    runs-on: ubuntu-latest
    needs: ["windows-build", "macos-build", "linux-build", "linux-arm-build"]
    environment:
      name: Test and Deploy
      url: https://pypi.org/p/perpetual
    permissions:
      id-token: write
    steps:
      - name: Retrieve release distributions
        uses: actions/download-artifact@v4
        with:
          pattern: dist-*
          merge-multiple: true
          path: dist
      - name: Publish release distributions to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

  r-release:
    runs-on: ubuntu-latest
    name: Build R Source Package (CRAN-ready)
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
    
    steps:
      - uses: actions/checkout@v4
      
      # Removed Copy LICENSE step to avoid Invalid DCF error (same as in CI)

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'
          
      - uses: r-lib/actions/setup-pandoc@v2

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::rcmdcheck, any::devtools
          working-directory: package-r

      - name: Prepare Vendored Core Crate
        run: |
          mkdir -p package-r/src/rust/core
          cp Cargo.toml package-r/src/rust/core/
          # Remove [workspace] section from the core crate to avoid multiple workspace roots
          sed -i '/^\[workspace\]/,/^$/d' package-r/src/rust/core/Cargo.toml
          cp -r src package-r/src/rust/core/

      - name: Vendor Rust Dependencies
        run: |
          cd package-r/src/rust
          mkdir -p .cargo
          cargo vendor > .cargo/config.toml
          # Append config to use vendored sources
          # cargo vendor output is already in the correct format for config.toml 
          # but we need to ensure it replaces crates-io
          cat .cargo/config.toml

      - name: Build Source Package
        run: |
          R CMD build package-r
          
      - name: Check Package (as CRAN)
        run: |
          # Run check on the built tarball
          tarball=$(ls perpetual_*.tar.gz)
          echo "Checking $tarball"
          Rscript -e "rcmdcheck::rcmdcheck(path = '$tarball', args = c('--as-cran'), error_on = 'error')"
          
      - name: Submit to CRAN
        run: |
          tarball=$(ls perpetual_*.tar.gz)
          echo "Submitting $tarball to CRAN"
          Rscript -e "devtools::submit_cran(file = '$tarball')"
          
      - name: Upload Release Asset
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: perpetual_*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Artifact (for workflow dispatch/testing)
        uses: actions/upload-artifact@v4
        with:
          name: perpetual-cran-source
          path: perpetual_*.tar.gz
